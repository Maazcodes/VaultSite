{% extends "vault/deposit.html" %}

{% block head_deposit %}
    <script src="/vault/static/js/flow.min.js"></script>
{% endblock head_deposit %}

{% set active_subnav = "test" %}
{% set breadcrumbs = (("Vault", "dashboard"), ("Deposit", "deposit"), ("Web Uploader", "deposit/flow")) %}

{% block content %}
<style>
    .area {
        width: 40em;
        margin-bottom: 1rem;
        margin-top: 3rem;
    }
    #dropTarget {
        border: 2px dashed #bbb;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        padding: 50px;
        text-align: center;
        font: 21pt bold arial;
        color: #bbb;
        background-color: white;
    }
    #progress_bar_flow {
        height: 24px;
        display: none;
        padding: 0;
        margin-top: 3px;
        margin-left: 10px;
    }
    #flow-stats {
        margin-top: -3px;
        margin-left: 5px;
        padding: 0;
        padding-top: 0.5rem;
        display: inline;
        margin-right: 1px;
    }
    #span_stats {
        display: flex;
    }
    .loader {
        margin-left: 15px;
        border: 4px solid white; /* Light grey */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 18px;
        height: 18px;
        animation: spin 1.1s linear infinite;
        display: inline-block;
        vertical-align: middle;        
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
<div class="row">
    <div class="small-8 columns">
        <h3>Upload Files</h3>
        {% if collections %}
        <form>
            {{ collection_form }}
        </form>
        <button class="button small padding-top padding-bottom half left" id="browseFilesButton">Browse Files</button>
        <button class="button small padding-top padding-bottom half left margin-left half" id="browseDirectoriesButton">Browse Folders</button>
        <div class="area">
            <div id="dropTarget"><p style="text-align: center; vertical-align: center">Drop Files here</p></div>
        </div>
        <input id="organization_quota" name="organization_quota" type="hidden" value="{{ request.user.organization.quota_bytes }}">
        <input id="total_used_quota" name="total_used_quota" type="hidden" value="{{ total_used_quota }}">
        <div>
           
            <button class="button small padding-top padding-bottom half left margin-right half"  id="flowPost" onclick="start_deposit(flow, files)">Upload</button>
           
            <div id="span_stats">
                <div id="flow-stats"></div>
                <progress id="progress_bar_flow" value="0" max="100" disabled="true"> 0% </progress>
            </div>
        </div>
        {% else %}
            <p>Create <a href="{{ url("collections") }}">your first collection</a> to start uploading files.</p>
        {% endif %}
    </div>
    <div class="small-4 columns" style=" display: inline;" id="collections-chart">
        <span class="spinner small"></span>
    </div>
</div>
<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h3>Create a new Collection</h3>
        </div>
        <form id="create_collection">
            {{ csrf_input }}
            <div class="modal-body">
                <input id="collection_name" type="text" placeholder="Enter Collection Name" required />
            </div>
            <div class="modal-footer">
                <input type="submit" value="Create Collection" class="button small" id="create_collection_submit_btn">
            </div>
            <div id="modal-message"></div>
        </form>
    </div>
</div>
<script>

var flow = new Flow({
  target:'{{ url("api_flow_chunk") }}',
  query:{upload_token:'my_token'},
  simultaneousUploads: 3,
  speedSmoothingFactor: 0.005,
  progressCallbacksInterval: 1000,
  maxChunkRetries: undefined,
  chunkRetryInterval: 5000,
  permanentErrors: [],
});


flow.assignBrowse(document.getElementById('browseFilesButton'));
flow.assignBrowse(document.getElementById('browseDirectoriesButton'), true);
flow.assignDrop(document.getElementById('dropTarget'));

let files = [];
let upload_size = 0;
let currentDepositId = undefined;

flow.on('fileAdded', function(file, event){
    let new_file = {
        "flow_identifier": file.uniqueIdentifier,
        "name": file.name,
        "relative_path": file.relativePath,
        "size": file.size,
        "type": file.file.type,
        "pre_deposit_modified_at": new Date(file.file.lastModified).toISOString(),
    };
    files.push(new_file);
    upload_size += new_file["size"];
    document.querySelector('#flow-stats').innerHTML = '<div>' + files.length + pluralizeWord(' file ', ' files ', files.length) + ' selected. Total Upload Size: ' + formatBytes(upload_size) + '</div>';
});

flow.on('fileSuccess', function(file,message){});

function pluralizeWord(singularWord, pluralWord, count) {

    return count != 1 ? pluralWord : singularWord;
}

flow.on('fileError', function(file, message){
    console.log(file, message);
    btn = document.getElementById("flowPost");
    btn.innerHTML = "Upload";
    btn.disabled = false;
    document.querySelector('#flow-stats').innerHTML = "Error Uploading";
});

function changeStats() {
    if($('#id_collection').find(":selected").val() != ""){
        document.querySelector('#flow-stats').innerHTML = '<div>' + files.length + pluralizeWord(' file ', ' files ', files.length) + ' selected. Total Upload Size: ' + formatBytes(upload_size) + '</div>';
    }
}

document.getElementById('id_collection').addEventListener("change", changeStats);

function deposit_status(time) {

    if (currentDepositId == undefined) {
        console.error("Deposit Id not defined");
    }
    let xhr = new XMLHttpRequest();
    xhr.open("GET", "{{ url("api_deposit_status") }}?deposit_id="+currentDepositId);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send();
    xhr.onloadend = function() {
        if (xhr.status == 200) {
		    res = JSON.parse(xhr.response);
            let message = "Processing Files: " + res["hashed_files"] + "/"  + res["total_files"] + ", Processing Queue: " + res["file_queue"] +  '<div class="loader"></div>';
            document.querySelector('#flow-stats').innerHTML = message;
            // if (time > 60) { // Processing files taking longer than 60 seconds
            //     console.error("Timeout: Processing files taking longer than 60 seconds");
            //     document.querySelector('#flow-stats').innerHTML = "Error Processing Files";
            //     return;
            // }
            if (res["hashed_files"] < res["total_files"]) {
                setTimeout(function(){ 
                deposit_status(time + 1) }, 1000);
            }
            else {
                document.getElementById("progress_bar_flow").innerHTML = "";
                document.querySelector('#flow-stats').innerHTML = "Upload Complete";
            }
        }
        else if (xhr.status == 400) {
           console.error("Deposit Error: No Deposit ID");
           document.querySelector('#flow-stats').innerHTML = "Deposit Error: No Deposit ID";
        }
        else if (xhr.status == 404) {
            console.error("Deposit Error: No Deposit for ID");
            document.querySelector('#flow-stats').innerHTML = "Deposit Error: No Deposit for ID"
        }
        else {
            console.error("API Error: Cannot Fetch Status of API");
            setTimeout(function(){console.log("Calling deposit_status again");
                deposit_status(time + 1) }, 1000);
        }
    }
}

flow.on('complete', function(){
    document.querySelector('#flow-stats').innerHTML = "Upload Complete";
    btn = document.getElementById("flowPost");
    btn.innerHTML = "Upload";
    btn.disabled = false;
    files = [];
    upload_size = 0;
    document.querySelector("#progress_bar_flow").style.display = 'none';
    deposit_status(0);
});

function secondsToString(seconds) {
    var remaining_min = Math.floor(seconds / 60);
    var remaining_sec = seconds - remaining_min * 60;

    // For hours
    var remaining_hours = Math.floor(seconds / 3600);
    var total_remaining_sec_hr = seconds - remaining_hours * 3600; // Total remaining seconds after hours
    var remaining_seconds_after_mins = Math.floor(total_remaining_sec_hr / 60); // Converting remaining seconds into minutes to get remaining minutes
    var actual_remaining_sec = seconds - remaining_seconds_after_mins * 60; // Getting remaining seconds after minutes

    if (seconds <= 60){
        return seconds + " s ";
    } else if (seconds > 60 && seconds <= 3600){
        return remaining_min + " m " + remaining_sec + " s ";
    } else if (seconds > 3600){
        return remaining_hours + " h " + remaining_seconds_after_mins + " m " + actual_remaining_sec + " s ";
    }

}

let initial_time = 0;
let sum_speed = 0;
let counter = 0;
flow.on('progress', function() {
    if (counter == 0) {
        initial_time = Date.now()
        counter ++;
        return
    }
    counter ++;
    let uploaded_size = flow.sizeUploaded();
    let passed_time = Date.now() - initial_time;
    let speed = uploaded_size / passed_time
    sum_speed += speed
    avg_speed = sum_speed / counter
    let total_file_size = flow.getSize()
    let time_remaining = (total_file_size - uploaded_size) / avg_speed
    document.querySelector('#flow-stats').innerHTML = "Uploading Files (" + " Time left: " + secondsToString(Math.floor(time_remaining / 1000)) + ") ";
    document.querySelector('#progress_bar_flow').value = flow.progress()*100;
});

function start_deposit(flow, files) {

    if ($('#id_collection').find(":selected").val() == "") {
        document.querySelector('#flow-stats').innerHTML = '<b>Please select a collection</b>';
        return;
    }

    if (files.length === 0) {
        document.querySelector('#flow-stats').innerHTML = '<b>Please select files/folders to upload.</b>';
        return;
    }

    document.querySelector('#progress_bar_flow').value = flow.progress()*0;
    btn = document.getElementById("flowPost");
    btn.innerHTML = "Uploading...";
    btn.disabled = true;
    document.querySelector('#flow-stats').innerHTML = "";

    //Showing progress bar
    document.getElementById('progress_bar_flow').style.display = 'inline-block';

    let coll_input = document.getElementById("id_collection");
    let collection_id = coll_input.options[coll_input.selectedIndex].value;

    function start(response) {
        let res = JSON.parse(response);
        flow.opts.query.depositId = res.deposit_id;
        currentDepositId = flow.opts.query.depositId;
        flow.upload();
    }

    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
        // In local files, status is 0 upon success in Mozilla Firefox
        if(xhr.readyState === XMLHttpRequest.DONE) {
            let status = xhr.status;
            if (status === 0 || (status >= 200 && status < 400)) {
                // The request has been completed successfully
                start(xhr.response);
            } else {
                console.error("Error on deposit registration", xhr.response);
            }
        }
    };
    let payload = {
        "collection_id": collection_id,
        "files": files,
        "total_size": upload_size
    }
    xhr.open("POST", "{{ url("api_register_deposit") }}", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(JSON.stringify(payload));
}

/// HELPER FUNCTIONS /// 
const formatBytes = (bytes, decimals = 2) => {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];

    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
};

const createQuotaDonut = () => {
        let data = [];
        data.push((parseInt(document.querySelector("#total_used_quota").value)/1024**3).toFixed(5));
        data.push( (
            parseInt(
                document.querySelector("#organization_quota").value -
                document.querySelector("#total_used_quota").value
            )/1024 ** 3 ).toFixed(5)
        );
        createCollectionsChart(["Used", "Available"], data);
    };

window.onload = function () {
    $("label[for='id_collection']").html("Collections:  <a href='javascript:void(0);' onclick='show_modal();'>Create a new Collection</a>")
    createQuotaDonut();
}

</script>
<script src="{{ static("digipres/js/chartalign.js") }}"></script>
<script src="{{ static("digipres/js/Chart.bundle.min.js") }}"></script>
<script type="text/javascript">
    $("#collections-chart .spinner").hide();
    function createCollectionsChart(collections, fileCounts) {
        $("#collections-chart .chart-container").remove();
        chartalign.register("#collections-chart", function () {
            return $("<canvas></canvas>").attr("width", '50px').attr("height", '45px');
        }, function ($el) {
            return new Chart($el.get(0), {
                type: 'doughnut',
                data: {
                    labels: collections,
                    datasets: [
                        {
                            label: "Collections",
                            backgroundColor: ["#3e95cd", "#8e5ea2", "#306ccd", "#a27698", "#21ba60", "#e8e6c5", "#c45850", "#3cba9f", "#e8c3b9", "#c45850"],
                            data: fileCounts
                        } 
                    ]
                },
                options: {  
                    legend: {display: false},
                    title: {
                        display: true,
                        text: 'Quota (in GiB)'
                    }
                }
            });
        }, function (chart) {
            chart.destroy();
        });
    }
    </script>
{% endblock content %}